schema: '2.0'
stages:
  load_moex:
    cmd: python workflows/load_moex_stocks_candles.py
    deps:
    - path: workflows/load_moex_stocks_candles.py
      md5: 9592b2df4a373ec8a482be70adaa45aa
      size: 1150
    params:
      workflows/params.yaml:
        load_moex:
          security: SBER
          start: '2021-01-01'
          end: '2021-01-31'
          interval: 1
          paths:
            output: data/raw/sber_2021_1_1.csv
        optuna_optimize:
          optimize_range:
            opt_min: 55
            opt_max: 57
            opt_step: 1
          model_prmt:
            max_iter: 10
            n_init: 1
            n_clusters: 10
          best_clusters: 10
          n_trials: 20
          model_name: KShape
          paths:
            input: ${slice_ts.paths.cluster}
            output:
              parametrs: models/KShape_best.yaml
              trials: models/trials.csv
        slice_ts:
          column_value: open
          period: 30
          step: 10
          rolling_period: 3
          predict_period: 10
          train_sample: -1
          paths:
            input: ${load_moex.paths.output}
            output:
              cluster: data/interim/sber_clst_2021_1_1.30_10.npy
              predict: data/interim/sber_prct_2021_1_1.30_10.csv
    outs:
    - path: data/raw/sber_2021_1_1.csv
      md5: 8934c8bf1776249a08f81b60584dcc50
      size: 972357
  slice_ts:
    cmd: python workflows/slice_moex_trading_ts.py --in_file=data/raw/sber_2021_1_1.csv
    deps:
    - path: data/raw/sber_2021_1_1.csv
      md5: 8934c8bf1776249a08f81b60584dcc50
      size: 972357
    - path: workflows/slice_moex_trading_ts.py
      md5: 26f2ce41cf0915a441a74b9b0f780b81
      size: 2346
    params:
      workflows/params.yaml:
        load_moex:
          security: SBER
          start: '2021-01-01'
          end: '2021-01-31'
          interval: 1
          paths:
            output: data/raw/sber_2021_1_1.csv
        optuna_optimize:
          optimize_range:
            opt_min: 55
            opt_max: 57
            opt_step: 1
          model_prmt:
            max_iter: 10
            n_init: 1
            n_clusters: 10
          best_clusters: 10
          n_trials: 20
          model_name: KShape
          paths:
            input: ${slice_ts.paths.cluster}
            output:
              parametrs: models/KShape_best.yaml
              trials: models/trials.csv
        slice_ts:
          column_value: open
          period: 30
          step: 10
          rolling_period: 3
          predict_period: 10
          train_sample: -1
          paths:
            input: ${load_moex.paths.output}
            output:
              cluster: data/interim/sber_clst_2021_1_1.30_10.npy
              predict: data/interim/sber_prct_2021_1_1.30_10.csv
    outs:
    - path: data/interim/sber_clst_2021_1_1.30_10.npy
      md5: 9a1e682089e466502bcbdeaf88baf1a2
      size: 355568
    - path: data/interim/sber_prct_2021_1_1.30_10.csv
      md5: df8bc9e374ad4b4944ed76bcab8ed012
      size: 1166044
  optuna_optimize:
    cmd: python workflows/optuna_optimize.py --in_file data/interim/sber_clst_2021_1_1.30_10.npy
      --model_name KShape --opt_min 55 --opt_max 57 --opt_step 1 --max_iter 10 --n_init
      1 --n_clusters 10 --best_clusters 10 --n_trials 20 --par_file models/KShape_best.yaml
      --trials_file models/trials.csv
    deps:
    - path: data/interim/sber_clst_2021_1_1.30_10.npy
      md5: 9a1e682089e466502bcbdeaf88baf1a2
      size: 355568
    - path: workflows/optuna_optimize.py
      md5: f07992d60e00b28c1b31f61940974ef6
      size: 3656
    params:
      workflows/params.yaml:
        load_moex:
          security: SBER
          start: '2021-01-01'
          end: '2021-01-31'
          interval: 1
          paths:
            output: data/raw/sber_2021_1_1.csv
        optuna_optimize:
          optimize_range:
            opt_min: 55
            opt_max: 57
            opt_step: 1
          model_prmt:
            max_iter: 10
            n_init: 1
            n_clusters: 10
          best_clusters: 10
          n_trials: 20
          model_name: KShape
          paths:
            input: ${slice_ts.paths.cluster}
            output:
              parametrs: models/KShape_best.yaml
              trials: models/trials.csv
        slice_ts:
          column_value: open
          period: 30
          step: 10
          rolling_period: 3
          predict_period: 10
          train_sample: -1
          paths:
            input: ${load_moex.paths.output}
            output:
              cluster: data/interim/sber_clst_2021_1_1.30_10.npy
              predict: data/interim/sber_prct_2021_1_1.30_10.csv
    outs:
    - path: models/KShape_best.yaml
      md5: 400a9528dd738eb374643c9ea46abebe
      size: 38
  clustering:
    cmd: python workflows/kshape_clustering.py --in_file data/interim/sber_clst_2021_1_1.30_10.npy
      --model_prms_yaml models/KShape_best.yaml
    deps:
    - path: data/interim/sber_clst_2021_1_1.30_10.npy
      md5: 9a1e682089e466502bcbdeaf88baf1a2
      size: 355568
    - path: models/KShape_best.yaml
      md5: 400a9528dd738eb374643c9ea46abebe
      size: 38
    - path: workflows/kshape_clustering.py
      md5: 804493ca3a1098a4f9546de7530c9e5c
      size: 3649
